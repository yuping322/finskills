# P1问题3：核心阈值历史回测验证计划

## 问题描述
- **问题**：大部分阈值是"初步估计"，缺少历史验证
- **影响**：约15个skills的阈值设置
- **优先级**：P1（中高）

## 验证目标

通过历史数据回测，验证methodology文档中的阈值合理性，并更新置信度。

## 优先验证的Skills

根据使用频率和重要性，优先验证以下5个核心skills：

### 1. block-deal-monitor（大宗交易监控）
**需要验证的阈值**：
- 折价率：-2% ~ -5%（温和折价）vs -7%（显著折价）
- 连续天数：3天
- 成交占比：10%
- 换手率变化：20%

**验证方法**：
- 样本：2020-2023年全A股大宗交易数据
- 信号：建仓型（温和折价+连续性）、抛压型（显著折价+高占比）
- 验证指标：后续20日收益率、10日最大回撤

### 2. concept-board-analyzer（概念板块分析）
**需要验证的阈值**：
- 相对强度：> 5%（强势板块）
- 资金流入：> 10亿
- 连续天数：3天
- 个股参与度：> 50%

**验证方法**：
- 样本：2020-2023年概念板块数据
- 信号：强势板块（相对强度+资金流入+连续性）
- 验证指标：后续5日、10日板块涨幅

### 3. equity-pledge-risk-monitor（股权质押风险监控）
**需要验证的阈值**：
- 质押比例：> 50%（高风险）
- 质押市值/流通市值：> 30%
- 平仓线距离：< 20%
- 质押方数量：> 3家

**验证方法**：
- 样本：2020-2023年股权质押数据
- 信号：高质押风险（质押比例+平仓线距离）
- 验证指标：后续3个月股价表现、风险事件发生率

### 4. fund-flow-monitor（资金流向监控）
**需要验证的阈值**：
- 主力净流入：> 1亿（大额流入）
- 连续天数：3天
- 北向资金：> 5亿
- 融资余额变化：> 5%

**验证方法**：
- 样本：2020-2023年资金流向数据
- 信号：大额持续流入（主力+北向+连续性）
- 验证指标：后续5日、10日股价涨幅

### 5. limit-up-pool-analyzer（涨停板分析）
**需要验证的阈值**：
- 涨停强度：封单金额 > 5000万
- 开板次数：< 3次（强势涨停）
- 连续涨停：2天以上
- 换手率：< 10%（筹码稳定）

**验证方法**：
- 样本：2020-2023年涨停板数据
- 信号：强势涨停（封单+开板次数+连续性）
- 验证指标：后续5日涨幅、连板持续性

## 回测框架

### 数据准备
```python
# 1. 获取历史数据
def get_historical_data(skill_name: str, start_date: str, end_date: str):
    """获取指定skill的历史数据"""
    # 从AKShare获取历史数据
    # 保存到本地缓存
    pass

# 2. 数据清洗
def clean_data(df):
    """清洗数据，处理缺失值和异常值"""
    # 剔除ST股票
    # 剔除停牌超过30天的股票
    # 处理缺失值
    pass
```

### 信号生成
```python
# 3. 生成信号
def generate_signals(df, thresholds: dict):
    """根据阈值生成交易信号"""
    # 应用规则生成信号
    # 标记信号触发时间和股票
    pass
```

### 回测验证
```python
# 4. 计算收益
def calculate_returns(signals, price_data, holding_period: int):
    """计算信号触发后的收益"""
    # 计算持有期收益率
    # 计算最大回撤
    # 计算胜率
    pass

# 5. 统计分析
def analyze_results(returns):
    """统计分析回测结果"""
    # 平均收益率
    # 收益率分布
    # 胜率
    # 夏普比率
    pass
```

### 阈值优化
```python
# 6. 阈值敏感性分析
def threshold_sensitivity(df, param_name: str, param_range: list):
    """测试不同阈值的效果"""
    results = []
    for value in param_range:
        thresholds = {param_name: value}
        signals = generate_signals(df, thresholds)
        returns = calculate_returns(signals, price_data, holding_period)
        results.append({
            'param_value': value,
            'avg_return': returns.mean(),
            'win_rate': (returns > 0).mean(),
            'sharpe': returns.mean() / returns.std()
        })
    return results
```

## 实施步骤

### 阶段1：框架搭建（1天）
- ✅ 创建回测框架代码
- ✅ 实现数据获取和清洗
- ✅ 实现信号生成逻辑
- ✅ 实现收益计算和统计

### 阶段2：单个skill回测（每个0.5-1天，共2.5-5天）
- ✅ block-deal-monitor回测
- ✅ concept-board-analyzer回测
- ✅ equity-pledge-risk-monitor回测
- ✅ fund-flow-monitor回测
- ✅ limit-up-pool-analyzer回测

### 阶段3：结果分析和文档更新（1天）
- ✅ 分析回测结果
- ✅ 更新methodology文档的置信度
- ✅ 更新阈值（如果需要）
- ✅ 编写回测报告

**总计**：4.5-7天

## 回测指标

### 收益指标
- **平均收益率**：所有信号的平均收益
- **中位数收益率**：收益率的中位数（更稳健）
- **收益率分布**：25%、50%、75%分位数
- **最大收益/最大亏损**：极端情况

### 风险指标
- **胜率**：收益 > 0的信号比例
- **盈亏比**：平均盈利 / 平均亏损
- **最大回撤**：持有期内的最大回撤
- **夏普比率**：收益 / 波动率

### 信号质量
- **信号数量**：总共触发的信号数
- **信号频率**：每月/每年的信号数
- **信号分布**：不同市场环境下的信号分布

## 置信度更新规则

根据回测结果更新置信度：

### 高置信度（0.70-0.80）
- 胜率 > 65%
- 平均收益率 > 10%
- 夏普比率 > 1.0
- 样本数量 > 100

### 中等置信度（0.60-0.70）
- 胜率 > 55%
- 平均收益率 > 5%
- 夏普比率 > 0.5
- 样本数量 > 50

### 低置信度（0.50-0.60）
- 胜率 > 50%
- 平均收益率 > 0%
- 夏普比率 > 0
- 样本数量 > 30

### 需要调整（< 0.50）
- 胜率 <= 50%
- 平均收益率 <= 0%
- 需要重新审视规则和阈值

## 输出文档

### 1. 回测报告（每个skill）
```markdown
# block-deal-monitor 回测报告

## 回测设置
- 时间范围：2020-01-01 至 2023-12-31
- 股票池：全A股（剔除ST）
- 信号：建仓型、抛压型

## 回测结果

### 规则1：建仓型信号
- 信号数量：1,234
- 平均收益率：8.5%
- 胜率：62%
- 夏普比率：0.85
- **置信度更新**：0.65 → 0.68

### 规则2：抛压型信号
- 信号数量：856
- 平均收益率（做空）：-12.3%
- 胜率：68%
- 夏普比率：1.12
- **置信度更新**：0.75 → 0.78

## 阈值敏感性分析

### 折价率阈值
| 阈值 | 信号数 | 平均收益 | 胜率 | 夏普比率 |
|------|--------|----------|------|----------|
| -2%  | 2,345  | 5.2%     | 58%  | 0.62     |
| -3%  | 1,678  | 6.8%     | 60%  | 0.75     |
| -5%  | 1,234  | 8.5%     | 62%  | 0.85     |
| -7%  | 856    | 10.2%    | 65%  | 0.95     |
| -10% | 423    | 12.8%    | 68%  | 1.05     |

**结论**：当前阈值-5%较为合理，平衡了信号数量和收益质量

## 建议
- 保持当前阈值不变
- 更新置信度为0.68
- 添加市场环境过滤（牛市/熊市）
```

### 2. 汇总报告
```markdown
# 5个核心Skills阈值回测汇总报告

## 总体结果
- 回测skills：5个
- 回测规则：20条
- 置信度提升：15条（75%）
- 阈值调整：3条（15%）
- 规则失效：2条（10%）

## 各skill表现
| Skill | 规则数 | 平均胜率 | 平均收益 | 置信度提升 |
|-------|--------|----------|----------|------------|
| block-deal-monitor | 4 | 64% | 9.2% | +0.03 |
| concept-board-analyzer | 4 | 58% | 7.5% | +0.02 |
| equity-pledge-risk-monitor | 4 | 62% | -8.3% | +0.05 |
| fund-flow-monitor | 4 | 56% | 6.8% | +0.01 |
| limit-up-pool-analyzer | 4 | 61% | 11.2% | +0.04 |

## 主要发现
1. 大部分规则的阈值设置合理
2. 部分规则需要添加市场环境过滤
3. 少数规则需要调整阈值或失效条件
```

## 风险和限制

### 数据质量
- **风险**：历史数据可能不完整或有错误
- **缓解**：数据清洗和异常值检测
- **验证**：对比多个数据源

### 过拟合
- **风险**：阈值优化可能导致过拟合
- **缓解**：使用训练集和测试集分离
- **验证**：样本外测试

### 市场环境变化
- **风险**：历史规律可能不适用于未来
- **缓解**：分不同市场环境回测
- **说明**：在文档中明确适用条件

### 交易成本
- **风险**：回测未考虑交易成本和滑点
- **缓解**：在收益计算中扣除合理的交易成本
- **说明**：在文档中说明实际收益会更低

## 成功标准

1. ✅ 完成5个核心skills的回测
2. ✅ 更新所有规则的置信度
3. ✅ 识别需要调整的阈值（如果有）
4. ✅ 编写详细的回测报告
5. ✅ 更新methodology文档

## 后续工作

1. **扩展回测**：对其他10个skills进行回测
2. **实时验证**：在实盘中验证回测结果
3. **定期更新**：每季度更新一次回测结果
4. **自动化**：开发自动化回测工具

## 相关文档

- [P1问题4-文档补充完成总结](./P1问题4-文档补充完成总结.md)
- [待修复问题优先级列表](./待修复问题优先级列表.md)
- [block-deal-monitor methodology](../China-market/block-deal-monitor/references/methodology.md)
