# P1问题2：备用数据源配置设计方案

## 问题描述
- **问题**：过度依赖AKShare单一数据源，接口不稳定时影响所有skills
- **影响**：高频使用的核心skills（约10个）
- **优先级**：P1（高）

## 设计目标

1. **高可用性**：当AKShare接口失败时，自动切换到备用数据源
2. **透明性**：对上层skills透明，无需修改现有代码
3. **可配置性**：支持配置每个工具的备用数据源优先级
4. **可监控性**：记录数据源使用情况和切换日志
5. **性能优化**：缓存机制，减少重复请求

## 核心数据源优先级

根据使用频率和重要性，优先为以下5个核心数据源添加备用：

### 1. stock_zh_a_spot_em（实时行情）
- **主数据源**：AKShare - 东方财富
- **备用数据源1**：腾讯财经API（已有部分实现）
- **备用数据源2**：新浪财经API
- **使用场景**：所有需要实时行情的skills

### 2. stock_zh_a_hist（历史行情）
- **主数据源**：AKShare - 东方财富
- **备用数据源1**：腾讯财经API
- **备用数据源2**：网易财经API
- **使用场景**：技术分析、回测、历史数据查询

### 3. stock_board_industry_spot_em（行业板块）
- **主数据源**：AKShare - 东方财富
- **备用数据源1**：同花顺API
- **备用数据源2**：腾讯财经API
- **使用场景**：行业分析、板块轮动

### 4. stock_board_concept_spot_em（概念板块）
- **主数据源**：AKShare - 东方财富
- **备用数据源1**：同花顺API
- **备用数据源2**：腾讯财经API
- **使用场景**：概念炒作、热点追踪

### 5. stock_hsgt_hold_stock_em（北向持股）
- **主数据源**：AKShare - 东方财富
- **备用数据源1**：Wind API（需要付费）
- **备用数据源2**：同花顺API
- **使用场景**：北向资金分析、外资动向

## 技术架构

### 1. 数据源抽象层

```python
class DataSource:
    """数据源抽象基类"""
    def __init__(self, name: str, priority: int):
        self.name = name
        self.priority = priority  # 优先级，数字越小优先级越高
        self.is_available = True
        self.last_check_time = None
        self.failure_count = 0
    
    def fetch(self, tool_name: str, **kwargs) -> Any:
        """获取数据的抽象方法"""
        raise NotImplementedError
    
    def check_health(self) -> bool:
        """健康检查"""
        raise NotImplementedError
```

### 2. 数据源管理器

```python
class DataSourceManager:
    """数据源管理器，负责数据源的选择和切换"""
    def __init__(self):
        self.sources: dict[str, list[DataSource]] = {}
        self.cache = {}
        self.stats = {}
    
    def register_source(self, tool_name: str, source: DataSource):
        """注册数据源"""
        if tool_name not in self.sources:
            self.sources[tool_name] = []
        self.sources[tool_name].append(source)
        self.sources[tool_name].sort(key=lambda s: s.priority)
    
    def fetch_with_fallback(self, tool_name: str, **kwargs) -> ToolResult:
        """带fallback的数据获取"""
        sources = self.sources.get(tool_name, [])
        if not sources:
            raise ValueError(f"No data source registered for {tool_name}")
        
        errors = []
        for source in sources:
            if not source.is_available:
                continue
            
            try:
                data = source.fetch(tool_name, **kwargs)
                self._record_success(tool_name, source.name)
                return ToolResult(
                    meta={"provider": source.name, "fallback_used": source.priority > 0},
                    data=data,
                    warnings=[],
                    errors=[]
                )
            except Exception as e:
                errors.append(f"{source.name}: {str(e)}")
                self._record_failure(tool_name, source.name)
                source.failure_count += 1
                
                # 连续失败5次，标记为不可用
                if source.failure_count >= 5:
                    source.is_available = False
        
        # 所有数据源都失败
        raise Exception(f"All data sources failed for {tool_name}: {errors}")
```

### 3. 具体数据源实现

#### AKShareDataSource（主数据源）
```python
class AKShareDataSource(DataSource):
    def __init__(self):
        super().__init__(name="akshare", priority=0)
    
    def fetch(self, tool_name: str, **kwargs) -> Any:
        import akshare as ak
        func = getattr(ak, tool_name)
        return func(**kwargs)
    
    def check_health(self) -> bool:
        # 使用现有的健康检查机制
        return check_akshare_health()
```

#### TencentDataSource（备用数据源1）
```python
class TencentDataSource(DataSource):
    def __init__(self):
        super().__init__(name="tencent", priority=1)
        self.base_url = "https://qt.gtimg.cn"
    
    def fetch(self, tool_name: str, **kwargs) -> Any:
        if tool_name == "stock_zh_a_spot_em":
            return self._fetch_realtime_quote(**kwargs)
        elif tool_name == "stock_zh_a_hist":
            return self._fetch_historical_data(**kwargs)
        else:
            raise NotImplementedError(f"Tencent source not implemented for {tool_name}")
    
    def _fetch_realtime_quote(self, symbol: str) -> list[dict]:
        # 实现腾讯实时行情获取
        pass
    
    def _fetch_historical_data(self, symbol: str, start_date: str, end_date: str) -> list[dict]:
        # 实现腾讯历史数据获取
        pass
```

#### SinaDataSource（备用数据源2）
```python
class SinaDataSource(DataSource):
    def __init__(self):
        super().__init__(name="sina", priority=2)
        self.base_url = "https://hq.sinajs.cn"
    
    def fetch(self, tool_name: str, **kwargs) -> Any:
        if tool_name == "stock_zh_a_spot_em":
            return self._fetch_realtime_quote(**kwargs)
        else:
            raise NotImplementedError(f"Sina source not implemented for {tool_name}")
    
    def _fetch_realtime_quote(self, symbol: str) -> list[dict]:
        # 实现新浪实时行情获取
        pass
```

## 配置文件

### backup_sources.json
```json
{
  "stock_zh_a_spot_em": {
    "sources": [
      {"name": "akshare", "priority": 0, "enabled": true},
      {"name": "tencent", "priority": 1, "enabled": true},
      {"name": "sina", "priority": 2, "enabled": true}
    ],
    "cache_ttl": 5,
    "retry_count": 3
  },
  "stock_zh_a_hist": {
    "sources": [
      {"name": "akshare", "priority": 0, "enabled": true},
      {"name": "tencent", "priority": 1, "enabled": true},
      {"name": "netease", "priority": 2, "enabled": false}
    ],
    "cache_ttl": 300,
    "retry_count": 3
  },
  "stock_board_industry_spot_em": {
    "sources": [
      {"name": "akshare", "priority": 0, "enabled": true},
      {"name": "tonghuashun", "priority": 1, "enabled": false},
      {"name": "tencent", "priority": 2, "enabled": true}
    ],
    "cache_ttl": 60,
    "retry_count": 3
  },
  "stock_board_concept_spot_em": {
    "sources": [
      {"name": "akshare", "priority": 0, "enabled": true},
      {"name": "tonghuashun", "priority": 1, "enabled": false},
      {"name": "tencent", "priority": 2, "enabled": true}
    ],
    "cache_ttl": 60,
    "retry_count": 3
  },
  "stock_hsgt_hold_stock_em": {
    "sources": [
      {"name": "akshare", "priority": 0, "enabled": true},
      {"name": "wind", "priority": 1, "enabled": false},
      {"name": "tonghuashun", "priority": 2, "enabled": false}
    ],
    "cache_ttl": 300,
    "retry_count": 3
  }
}
```

## 实施计划

### 阶段1：基础架构（1-2天）
- ✅ 创建DataSource抽象基类
- ✅ 创建DataSourceManager管理器
- ✅ 实现配置文件加载
- ✅ 集成到provider_akshare.py

### 阶段2：核心数据源实现（3-4天）
- ✅ 实现TencentDataSource（腾讯财经）
  - stock_zh_a_spot_em（实时行情）
  - stock_zh_a_hist（历史行情）
- ✅ 实现SinaDataSource（新浪财经）
  - stock_zh_a_spot_em（实时行情）
- ⏳ 实现NeteaseDataSource（网易财经）
  - stock_zh_a_hist（历史行情）

### 阶段3：测试和优化（2-3天）
- ✅ 单元测试（每个数据源）
- ✅ 集成测试（fallback机制）
- ✅ 性能测试（缓存效果）
- ✅ 压力测试（并发请求）

### 阶段4：监控和文档（1-2天）
- ✅ 添加数据源使用统计
- ✅ 添加切换日志
- ✅ 编写使用文档
- ✅ 更新methodology文档

## 监控指标

### 数据源健康度
- 成功率：成功请求数 / 总请求数
- 平均响应时间：所有请求的平均耗时
- 可用性：当前是否可用
- 失败次数：连续失败次数

### 切换统计
- 切换次数：主数据源失败导致的切换次数
- 切换成功率：切换后成功获取数据的比例
- 备用数据源使用率：备用数据源被使用的比例

### CLI命令
```bash
# 查看数据源状态
python -m view_service.backup_sources_cli status

# 查看数据源统计
python -m view_service.backup_sources_cli stats

# 查看切换日志
python -m view_service.backup_sources_cli logs --tool stock_zh_a_spot_em

# 重置数据源状态
python -m view_service.backup_sources_cli reset --source tencent
```

## 降级策略

### 自动降级
- 连续失败5次：标记数据源为不可用
- 不可用持续时间：10分钟后自动重试
- 重试成功：恢复可用状态

### 手动降级
- 配置文件禁用：enabled: false
- CLI命令禁用：backup_sources_cli disable --source tencent
- 环境变量禁用：BACKUP_SOURCES_DISABLED=tencent,sina

## 风险和限制

### 数据一致性
- **风险**：不同数据源的数据可能不一致
- **缓解**：优先使用主数据源，仅在失败时切换
- **验证**：定期对比不同数据源的数据差异

### API限制
- **风险**：免费API有请求频率限制
- **缓解**：添加请求频率控制和缓存
- **监控**：记录API调用次数和限流情况

### 维护成本
- **风险**：多个数据源需要维护和更新
- **缓解**：优先实现最核心的5个数据源
- **文档**：详细记录每个数据源的实现和限制

## 成功标准

1. **可用性提升**：核心数据源可用性从95%提升到99%+
2. **切换成功率**：备用数据源切换成功率 > 90%
3. **性能影响**：切换到备用数据源的响应时间 < 主数据源的2倍
4. **透明性**：上层skills无需修改代码
5. **可监控性**：完整的监控指标和日志

## 后续优化

1. **智能切换**：根据历史成功率动态调整数据源优先级
2. **数据融合**：多个数据源的数据融合和交叉验证
3. **预测性切换**：根据健康检查结果提前切换
4. **更多数据源**：扩展到更多的数据源和工具

## 相关文档

- [P1问题1-健康检查机制实现总结](./P1问题1-健康检查机制实现总结.md)
- [待修复问题优先级列表](./待修复问题优先级列表.md)
- [AKShare健康检查文档](../view-service/AKSHARE_HEALTH_CHECK.md)
