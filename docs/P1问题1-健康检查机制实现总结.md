# P1é—®é¢˜1ï¼šAKShareå¥åº·æ£€æŸ¥æœºåˆ¶å®ç°æ€»ç»“

## å®Œæˆæ—¶é—´
2026-02-16

## é—®é¢˜æè¿°
- **é—®é¢˜**ï¼šAKShareæ¥å£ä¸ç¨³å®šï¼Œç¼ºå°‘å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
- **å½±å“**ï¼šæ‰€æœ‰56ä¸ªChina-market skills
- **ä¼˜å…ˆçº§**ï¼šP1ï¼ˆé«˜ï¼‰

## è§£å†³æ–¹æ¡ˆ

### 1. å¥åº·æ£€æŸ¥æ¨¡å—ï¼ˆakshare_health.pyï¼‰

å®ç°äº†å®Œæ•´çš„å¥åº·ç›‘æ§ç³»ç»Ÿï¼š

```python
class AKShareHealthMonitor:
    - check_health(): å®šæœŸæ£€æµ‹AKShareå¯ç”¨æ€§
    - record_call(): è®°å½•æ¯æ¬¡è°ƒç”¨ç»“æœ
    - is_degraded(): æ£€æŸ¥æ˜¯å¦å¤„äºé™çº§æ¨¡å¼
    - get_stats(): è·å–ç»Ÿè®¡ä¿¡æ¯
    - get_health_summary(): è·å–å¥åº·æ‘˜è¦
```

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ä½¿ç”¨è½»é‡çº§æ¥å£ï¼ˆstock_info_a_code_nameï¼‰æ£€æµ‹è¿æ¥æ€§
- é»˜è®¤æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- è®°å½•å“åº”æ—¶é—´å’Œé”™è¯¯ä¿¡æ¯
- æ”¯æŒå¼ºåˆ¶æ£€æŸ¥å’Œç¼“å­˜æœºåˆ¶

### 2. é”™è¯¯ç»Ÿè®¡å’Œç›‘æ§

**ç»Ÿè®¡ç»´åº¦**ï¼š
- æ€»è°ƒç”¨æ¬¡æ•°
- å¤±è´¥æ¬¡æ•°
- æˆåŠŸç‡
- è¿ç»­å¤±è´¥æ¬¡æ•°
- æœ€åé”™è¯¯æ—¶é—´å’Œä¿¡æ¯

**é”™è¯¯åˆ†ç±»**ï¼š
- timeout: è¶…æ—¶é”™è¯¯
- network: ç½‘ç»œè¿æ¥é”™è¯¯
- data_missing: æ•°æ®ç¼ºå¤±ï¼ˆKeyErrorï¼‰
- access_denied: è®¿é—®è¢«æ‹’ç»ï¼ˆ403ï¼‰
- not_found: èµ„æºä¸å­˜åœ¨ï¼ˆ404ï¼‰
- server_error: æœåŠ¡å™¨é”™è¯¯ï¼ˆ500/502/503ï¼‰
- unknown: æœªçŸ¥é”™è¯¯

### 3. è‡ªåŠ¨é™çº§æœºåˆ¶

**è§¦å‘æ¡ä»¶**ï¼š
- è¿ç»­å¤±è´¥æ¬¡æ•° >= é˜ˆå€¼ï¼ˆé»˜è®¤5æ¬¡ï¼‰

**é™çº§ç­–ç•¥**ï¼š
- å‡å°‘é‡è¯•æ¬¡æ•°ï¼ˆå‡åŠï¼‰
- ç¼©çŸ­é‡è¯•ç­‰å¾…æ—¶é—´
- æ·»åŠ é¢å¤–çš„é€€é¿æ—¶é—´

**è‡ªåŠ¨æ¢å¤**ï¼š
- æˆåŠŸè°ƒç”¨åè‡ªåŠ¨æ¢å¤æ­£å¸¸æ¨¡å¼

### 4. å¢å¼ºçš„é‡è¯•æœºåˆ¶

**å¯é‡è¯•é”™è¯¯ç±»å‹**ï¼š
- RemoteDisconnected
- Connection aborted
- Read timed out
- Max retries exceeded
- UNEXPECTED_EOF_WHILE_READING
- SSLEOFError
- SSLV3_ALERT_HANDSHAKE_FAILURE
- ConnectionError
- Timeout
- HTTPError

**é‡è¯•ç­–ç•¥**ï¼š
- æŒ‡æ•°é€€é¿ï¼šwait_time = retry_sleep * (attempt + 1)
- é™çº§æ¨¡å¼ä¸‹é¢å¤–é€€é¿ï¼šwait_time *= 1.5

### 5. CLIå·¥å…·ï¼ˆhealth_check_cli.pyï¼‰

æä¾›4ä¸ªå‘½ä»¤ï¼š

```bash
# æ‰§è¡Œå¥åº·æ£€æŸ¥
python -m view_service.health_check_cli check [--force]

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
python -m view_service.health_check_cli stats [--tool TOOL_NAME]

# æŸ¥çœ‹å¥åº·æ‘˜è¦
python -m view_service.health_check_cli summary [--json]

# é‡ç½®ç»Ÿè®¡ä¿¡æ¯
python -m view_service.health_check_cli reset [--tool TOOL_NAME]
```

### 6. Provideré›†æˆ

åœ¨`provider_akshare.py`ä¸­è‡ªåŠ¨é›†æˆï¼š

```python
def call_tool(self, name, args, *, refresh, meta_script):
    # 1. è·å–å¥åº·ç›‘æ§å™¨
    health_monitor = get_health_monitor()
    
    # 2. æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if health_check_enabled:
        health_result = check_akshare_health(force=False)
    
    # 3. è°ƒç”¨AKShareæ¥å£
    try:
        result = func(**call_kwargs)
        # è®°å½•æˆåŠŸ
        health_monitor.record_call(name, success=True)
    except Exception as e:
        # è®°å½•å¤±è´¥
        health_monitor.record_call(name, success=False, error=str(e))
        # æ™ºèƒ½é‡è¯•
        ...
    
    # 4. è¿”å›ç»“æœï¼ˆåŒ…å«å¥åº·çŠ¶æ€ï¼‰
    return ToolResult(
        meta={
            ...
            "health_status": {
                "is_degraded": health_monitor.is_degraded(),
                "consecutive_failures": stats.consecutive_failures,
            }
        },
        ...
    )
```

## é…ç½®é€‰é¡¹

```bash
# å¥åº·æ£€æŸ¥é…ç½®
export FINSKILLS_HEALTH_CHECK_ENABLED=1           # å¯ç”¨å¥åº·æ£€æŸ¥ï¼ˆé»˜è®¤ï¼š1ï¼‰
export FINSKILLS_HEALTH_CHECK_INTERVAL=300        # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼Œé»˜è®¤ï¼š300ï¼‰

# é™çº§é…ç½®
export FINSKILLS_DEGRADATION_THRESHOLD=5          # é™çº§é˜ˆå€¼ï¼ˆé»˜è®¤ï¼š5æ¬¡ï¼‰
export FINSKILLS_DEGRADATION_WINDOW=300           # é™çº§çª—å£ï¼ˆç§’ï¼Œé»˜è®¤ï¼š300ï¼‰

# é‡è¯•é…ç½®
export FINSKILLS_CALL_RETRIES=1                   # æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š1ï¼‰
export FINSKILLS_CALL_RETRY_SLEEP=0.3             # é‡è¯•ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ï¼š0.3ï¼‰
export FINSKILLS_DEFAULT_TIMEOUT=10               # é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ï¼š10ï¼‰
```

## æµ‹è¯•ç»“æœ

### æµ‹è¯•1ï¼šå¥åº·æ£€æŸ¥
```
å¥åº·çŠ¶æ€: âœ… å¥åº·
å“åº”æ—¶é—´: 7.117ç§’
```

### æµ‹è¯•2ï¼šç»Ÿè®¡è®°å½•
```
ç»Ÿè®¡ç»“æœ:
  æ€»è°ƒç”¨: 13
  å¤±è´¥: 3
  æˆåŠŸç‡: 76.92%
  è¿ç»­å¤±è´¥: 3
```

### æµ‹è¯•3ï¼šé™çº§æœºåˆ¶
```
æ¨¡æ‹Ÿè¿ç»­å¤±è´¥ä»¥è§¦å‘é™çº§...
  å¤±è´¥ 1/5: é™çº§çŠ¶æ€ = False
  å¤±è´¥ 2/5: é™çº§çŠ¶æ€ = False
  å¤±è´¥ 3/5: é™çº§çŠ¶æ€ = False
  å¤±è´¥ 4/5: é™çº§çŠ¶æ€ = False
  å¤±è´¥ 5/5: é™çº§çŠ¶æ€ = True  â† è§¦å‘é™çº§
  å¤±è´¥ 6/5: é™çº§çŠ¶æ€ = True

æœ€ç»ˆé™çº§çŠ¶æ€: ğŸ”´ å·²é™çº§

æ¨¡æ‹ŸæˆåŠŸè°ƒç”¨ä»¥æ¢å¤...
æ¢å¤åçŠ¶æ€: âœ… æ­£å¸¸  â† è‡ªåŠ¨æ¢å¤
```

### æµ‹è¯•4ï¼šé”™è¯¯åˆ†ç±»
```
é”™è¯¯ç±»å‹åˆ†å¸ƒ:
  timeout: 1
  network: 1
  data_missing: 1
  access_denied: 1
  not_found: 1
  server_error: 1
  unknown: 1
```

### æµ‹è¯•5ï¼šå¥åº·æ‘˜è¦
```
å¥åº·æ‘˜è¦:
  å¥åº·çŠ¶æ€: True
  é™çº§æ¨¡å¼: True
  æ€»è°ƒç”¨: 7
  å¤±è´¥: 7
  æˆåŠŸç‡: 0.0%
```

## æ€§èƒ½å½±å“

- **å¥åº·æ£€æŸ¥**ï¼šæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œå“åº”æ—¶é—´çº¦7ç§’
- **ç»Ÿè®¡è®°å½•**ï¼šæ¯æ¬¡è°ƒç”¨å¢åŠ çº¦0.1mså¼€é”€
- **å†…å­˜å ç”¨**ï¼šçº¦1-2MBï¼ˆå–å†³äºç»Ÿè®¡çš„å·¥å…·æ•°é‡ï¼‰

## æ–‡ä»¶æ¸…å•

1. `view-service/view_service/akshare_health.py` - å¥åº·æ£€æŸ¥æ¨¡å—ï¼ˆ380è¡Œï¼‰
2. `view-service/view_service/health_check_cli.py` - CLIå·¥å…·ï¼ˆ280è¡Œï¼‰
3. `view-service/view_service/provider_akshare.py` - Provideré›†æˆï¼ˆä¿®æ”¹ï¼‰
4. `view-service/AKSHARE_HEALTH_CHECK.md` - ä½¿ç”¨æ–‡æ¡£ï¼ˆ450è¡Œï¼‰
5. `view-service/test_health_check.py` - æµ‹è¯•è„šæœ¬ï¼ˆ180è¡Œï¼‰

## æäº¤è®°å½•

- commit 9c19da3: å®ç°AKShareå¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆP1é—®é¢˜1ï¼‰
- commit 22fefe6: æ›´æ–°å¾…ä¿®å¤é—®é¢˜åˆ—è¡¨ï¼šæ ‡è®°P1é—®é¢˜1ä¸ºå·²å®Œæˆ

## ä½¿ç”¨ç¤ºä¾‹

### 1. æ‰§è¡Œå¥åº·æ£€æŸ¥
```bash
python -m view_service.health_check_cli check --force
```

### 2. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
```bash
python -m view_service.health_check_cli stats
```

### 3. æŸ¥çœ‹å¥åº·æ‘˜è¦
```bash
python -m view_service.health_check_cli summary
```

### 4. åœ¨ä»£ç ä¸­ä½¿ç”¨
```python
from view_service.akshare_health import (
    check_akshare_health,
    is_akshare_degraded,
    get_health_monitor,
)

# æ£€æŸ¥å¥åº·çŠ¶æ€
result = check_akshare_health()
if not result.is_healthy:
    print(f"è­¦å‘Šï¼šAKShareä¸å¥åº· - {result.error}")

# æ£€æŸ¥æ˜¯å¦é™çº§
if is_akshare_degraded():
    print("è­¦å‘Šï¼šAKShareå¤„äºé™çº§æ¨¡å¼")

# è·å–ç»Ÿè®¡ä¿¡æ¯
monitor = get_health_monitor()
stats = monitor.get_stats("stock_zh_a_spot_em")
print(f"æˆåŠŸç‡: {(stats.total_calls - stats.failed_calls) / stats.total_calls * 100:.2f}%")
```

## åç»­æ”¹è¿›

1. **æŒä¹…åŒ–ç»Ÿè®¡**ï¼šå°†ç»Ÿè®¡ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶æˆ–æ•°æ®åº“
2. **å‘Šè­¦é›†æˆ**ï¼šé›†æˆåˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€Grafanaï¼‰
3. **è‡ªåŠ¨æ¢å¤**ï¼šè‡ªåŠ¨å°è¯•æ¢å¤å¤±è´¥çš„æ¥å£
4. **é¢„æµ‹æ€§å‘Šè­¦**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹å¯èƒ½çš„æ•…éšœ
5. **åˆ†å¸ƒå¼ç›‘æ§**ï¼šæ”¯æŒå¤šå®ä¾‹ç¯å¢ƒä¸‹çš„ç»Ÿä¸€ç›‘æ§

## ç›¸å…³æ–‡æ¡£

- [AKShareå¥åº·æ£€æŸ¥ä½¿ç”¨æ–‡æ¡£](../view-service/AKSHARE_HEALTH_CHECK.md)
- [å¾…ä¿®å¤é—®é¢˜ä¼˜å…ˆçº§åˆ—è¡¨](./å¾…ä¿®å¤é—®é¢˜ä¼˜å…ˆçº§åˆ—è¡¨.md)
- [P0é—®é¢˜ä¿®å¤æ€»ç»“](./P0é—®é¢˜ä¿®å¤æ€»ç»“.md)

## æ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„AKShareå¥åº·æ£€æŸ¥æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å¥åº·æ£€æŸ¥ï¼ˆå®šæœŸæ£€æµ‹ï¼‰
- âœ… é”™è¯¯ç»Ÿè®¡ï¼ˆ7ç§é”™è¯¯ç±»å‹ï¼‰
- âœ… è‡ªåŠ¨é™çº§ï¼ˆè¿ç»­å¤±è´¥5æ¬¡è§¦å‘ï¼‰
- âœ… å¢å¼ºé‡è¯•ï¼ˆæ™ºèƒ½é€€é¿ï¼‰
- âœ… CLIå·¥å…·ï¼ˆ4ä¸ªå‘½ä»¤ï¼‰
- âœ… Provideré›†æˆï¼ˆè‡ªåŠ¨è®°å½•ï¼‰

è¯¥æœºåˆ¶å°†æ˜¾è‘—æé«˜æ‰€æœ‰56ä¸ªChina-market skillsçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚
